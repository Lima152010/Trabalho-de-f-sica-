<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <title>Movimento Parabolico com Imagem</title>
    <link rel="stylesheet" href="../CSSs/stylePa.css">
    <link rel="shortcut icon" href="../img/logo.png" type="image/x-icon">
</head>
<body>
    <div id="corte"></div>
    <div id="container">
        <header>
            <h2>Simulador de Movimento Parabolico</h2>
            <img style="margin-left: 15px;" width="50px" src="../img/logo.png" alt="">
        </header>

        <div id="forms">
            <label>Posição Inicial (m): <input type="number" id="posInicial" value="0"></label>
            <label>Posição Final (m): <input type="number" id="posFinal" value="100"></label>
            <label>Velocidade (m/s): <input type="number" id="velocidade" value="10"></label>
            <br>
            <button onclick="iniciar()">Iniciar</button>
            <label>Velocidade Inicial do Míssil (m/s): <input type="number" id="velInicialMissil" value="50"></label>
            <label>Ângulo de Lançamento (graus): <input type="number" id="anguloLancamento" value="45"></label>
            <button onclick="lancarMissil()">Lançar Míssil</button>
        </div>
        <div id="resultados">
            <canvas id="animacao" width="1080" height="460"></canvas>
            <h2 id="re"></h2>
            <div id="tabelaResultados"></div>
            <div id="exe">
                <h1>Movimento Parabolico</h1>
                <p>Lorem ipsum dolor sit amet consectetur, adipisicing elit. Cum consectetur iste culpa, in incidunt quis illum ad assumenda eligendi velit, quia voluptates ab nulla dignissimos quos? Laudantium temporibus corporis esse!
                </p>
            </div>
        </div>
    </div>
    <footer>
        &copy; Todos direitos reservados &reg;
    </footer>

    <script>
        // Constantes físicas
        const GRAVIDADE = 9.8; // m/s²
        const ESCALA_ALTURA = 0.5;
        const FPS = 60;
        
        // Elementos do DOM
        const canvas = document.getElementById('animacao');
        const ctx = canvas.getContext('2d');
        const largura = canvas.width;
        const altura = canvas.height;
        
        // Variáveis de estado
        let animacaoAtiva = false;
        let posAtual = 0;
        let s0 = 0, sf = 100, v = 10;
        let escala = largura / 100;
        let direcao = 1;
        
        // Variáveis do míssil
        let missilAtivo = false;
        let missilX = 0, missilY = 0;
        let missilTempo = 0;
        let missilVelInicial = 30;
        let missilAnguloRad = Math.PI/4;
        let particulasFumaca = [];
        
        // Controle de animação
        let ultimoTempo = 0;
        const intervaloFrame = 1000 / FPS;
    
        // Função principal de inicialização
        function iniciar() {
            s0 = parseFloat(document.getElementById('posInicial').value);
            sf = parseFloat(document.getElementById('posFinal').value);
            v = parseFloat(document.getElementById('velocidade').value);
            
            const distancia = Math.abs(sf - s0);
            escala = largura / distancia;
            posAtual = s0;
            direcao = sf >= s0 ? 1 : -1;
            
            if (!animacaoAtiva) {
                animacaoAtiva = true;
                ultimoTempo = performance.now();
                requestAnimationFrame(animar);
            }
        }
    
        // Função para lançar o míssil
        function lancarMissil() {
            if (missilAtivo) return; // Impede múltiplos lançamentos simultâneos
            
            missilVelInicial = parseFloat(document.getElementById('velInicialMissil').value);
            const angulo = parseFloat(document.getElementById('anguloLancamento').value);
            missilAnguloRad = angulo * Math.PI / 180;
            
            missilTempo = 0;
            missilAtivo = true;
            missilX = 50;
            missilY = altura - 50;
            particulasFumaca = [];
            
            if (!animacaoAtiva) {
                animacaoAtiva = true;
                ultimoTempo = performance.now();
                requestAnimationFrame(animar);
            }
        }
    
        // Função de animação principal com controle de FPS
        function animar(tempoAtual) {
            if (!animacaoAtiva) return;
            
            const deltaTempo = tempoAtual - ultimoTempo;
            
            if (deltaTempo >= intervaloFrame) {
                ultimoTempo = tempoAtual - (deltaTempo % intervaloFrame);
                
                ctx.clearRect(0, 0, largura, altura);
                desenharCenario();
                
                // Atualizar e desenhar carro
                const xCarro = (posAtual - s0) * escala;
                const yCarro = altura - 70;
                if (imgCarro.complete) {
                    ctx.drawImage(imgCarro, xCarro, yCarro, 80, 50);
                }
                
                // Atualizar posição do carro
                if (!((direcao === 1 && posAtual >= sf) || (direcao === -1 && posAtual <= sf))) {
                    posAtual += (v / FPS) * direcao;
                }
                
                // Lógica do míssil
                if (missilAtivo) {
                    atualizarMissil(xCarro, yCarro);
                    desenharFumaca();
                }
            }
            
            requestAnimationFrame(animar);
        }
    
        function desenharCenario() {
            // Chão
            ctx.fillStyle = '#4a3824';
            ctx.fillRect(0, altura - 30, largura, 30);
            
            // Linha de trajeto
            ctx.strokeStyle = '#888';
            ctx.beginPath();
            ctx.moveTo(0, altura - 50);
            ctx.lineTo(largura, altura - 50);
            ctx.stroke();
        }
    
        function atualizarMissil(xAlvo, yAlvo) {
            missilTempo += 1/FPS;
            
            // Cálculo seguro da posição
            try {
                missilX = 50 + (missilVelInicial * Math.cos(missilAnguloRad) * missilTempo) * escala;
                const termoVertical = (missilVelInicial * Math.sin(missilAnguloRad) * missilTempo - 
                                     0.5 * GRAVIDADE * missilTempo * missilTempo);
                missilY = (altura - 50) - (termoVertical * ESCALA_ALTURA * escala);
                
                // Limitar valores para evitar NaN
                if (isNaN(missilX) || isNaN(missilY)) {
                    throw new Error("Valores inválidos na trajetória");
                }
            } catch (e) {
                console.error("Erro no cálculo da trajetória:", e);
                missilAtivo = false;
                return;
            }
            
            // Adicionar fumaça com verificação de limites
            if (Math.random() < 0.3 && missilY < altura - 30) {
                particulasFumaca.push({
                    x: Math.max(0, Math.min(missilX - 10, largura)),
                    y: Math.max(0, Math.min(missilY + 10, altura)),
                    size: Math.random() * 5 + 2,
                    alpha: 1,
                    life: 30
                });
            }
            
            // Rotacionar míssil
            if (imgMissil.complete) {
                const velX = missilVelInicial * Math.cos(missilAnguloRad);
                const velY = missilVelInicial * Math.sin(missilAnguloRad) - GRAVIDADE * missilTempo;
                const anguloAtual = Math.atan2(velY, velX);
                
                ctx.save();
                ctx.translate(missilX, missilY);
                ctx.rotate(anguloAtual);
                ctx.drawImage(imgMissil, -15, -8, 30, 16);
                ctx.restore();
            }
            
            // Verificar limites
            if (missilY > altura - 30 || missilX > largura || missilX < 0 || missilY < 0) {
                missilAtivo = false;
                console.log("Míssil saiu da área");
            }
            
            // Colisão com o carro (com tolerância)
            if (Math.abs(missilX - xAlvo) < 40 && Math.abs(missilY - yAlvo) < 30) {
                missilAtivo = false;
                console.log("Míssil acertou o alvo!");
            }
        }
    
        function desenharFumaca() {
            for (let i = particulasFumaca.length - 1; i >= 0; i--) {
                const p = particulasFumaca[i];
                p.life--;
                p.alpha = p.life / 30;
                p.y += 1;
                
                ctx.fillStyle = `rgba(150, 150, 150, ${p.alpha})`;
                ctx.beginPath();
                ctx.arc(p.x, p.y, p.size, 0, Math.PI * 2);
                ctx.fill();
                
                if (p.life <= 0) {
                    particulasFumaca.splice(i, 1);
                }
            }
        }
    
        // Carregar imagens com fallback
        const imgCarro = new Image();
        imgCarro.src = '../img/carro_vermelho.png';
        imgCarro.onerror = () => {
            console.log("Erro ao carregar imagem do carro");
            // Pode adicionar um retângulo como fallback
        };
        
        const imgMissil = new Image();
        imgMissil.src = '../img/rocket.webp';
        imgMissil.onerror = () => {
            console.log("Erro ao carregar imagem do míssil");
            // Pode adicionar um retângulo como fallback
        };
    </script>
</body>
</html>